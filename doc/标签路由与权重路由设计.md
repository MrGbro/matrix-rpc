# Matrix RPC æ ‡ç­¾è·¯ç”±ä¸æƒé‡è·¯ç”±è®¾è®¡æ–¹æ¡ˆ

## 1. éœ€æ±‚æ¾„æ¸…

åŸºäº Dubbo çš„å®è·µå’Œ Matrix RPC çš„ç°çŠ¶ï¼Œæ˜ç¡®ä»¥ä¸‹éœ€æ±‚è¾¹ç•Œï¼š

### 1.1 åŠŸèƒ½è¾¹ç•Œ

**æ ‡ç­¾è·¯ç”±ï¼ˆTag Routingï¼‰**ï¼š
- æ”¯æŒå°†æœåŠ¡å®ä¾‹æŒ‰æ ‡ç­¾åˆ†ç»„ï¼ˆå¦‚ `env=gray`ã€`version=v2`ï¼‰
- æ¶ˆè´¹è€…è¯·æ±‚æºå¸¦æ ‡ç­¾ï¼Œä»…è·¯ç”±åˆ°åŒ¹é…æ ‡ç­¾çš„å®ä¾‹
- æ”¯æŒæ ‡ç­¾ä¼˜å…ˆ + å…œåº•é€»è¾‘ï¼ˆæ— æ ‡ç­¾å®ä¾‹ä½œä¸ºé™çº§ï¼‰
- é€‚ç”¨åœºæ™¯ï¼šç°åº¦å‘å¸ƒã€è“ç»¿éƒ¨ç½²ã€ç¯å¢ƒéš”ç¦»

**æƒé‡è·¯ç”±ï¼ˆWeight Routingï¼‰**ï¼š
- æ¯ä¸ªæœåŠ¡å®ä¾‹å¯é…ç½®æƒé‡å€¼ï¼ˆé»˜è®¤ 100ï¼‰
- è´Ÿè½½å‡è¡¡æŒ‰æƒé‡æ¯”ä¾‹åˆ†é…æµé‡
- åŠ¨æ€è°ƒæ•´æƒé‡å®ç°æµé‡è¿ç§»
- é€‚ç”¨åœºæ™¯ï¼šæ–°ç‰ˆæœ¬ç°åº¦ã€æœºå™¨é™çº§ã€åŒºåŸŸæµé‡æ§åˆ¶

### 1.2 éåŠŸèƒ½æŒ‡æ ‡

- **æ€§èƒ½å½±å“**ï¼šè·¯ç”±è®¡ç®— < 1msï¼Œä¸å½±å“ P99
- **å†…å­˜å¼€é”€**ï¼šæ¯ä¸ª URL å¢åŠ çº¦ 100 å­—èŠ‚ï¼ˆæ ‡ç­¾ + æƒé‡ï¼‰
- **æ‰©å±•æ€§**ï¼šæ”¯æŒè‡ªå®šä¹‰è·¯ç”±ç­–ç•¥ï¼ˆSPIï¼‰
- **å‘åå…¼å®¹**ï¼šä¸å½±å“ç°æœ‰è´Ÿè½½å‡è¡¡å’Œé›†ç¾¤é€»è¾‘

## 2. è®¾è®¡æ€è·¯

### 2.1 è®¾è®¡åŠ¨æœº

**Dubbo çš„é—®é¢˜**ï¼š
1. Router é“¾å¼è°ƒç”¨å¤æ‚ï¼Œéš¾ä»¥ç†è§£
2. æ ‡ç­¾è·¯ç”±å’Œè´Ÿè½½å‡è¡¡åˆ†ç¦»ï¼Œé€»è¾‘é‡å¤
3. åŠ¨æ€è§„åˆ™ä¾èµ–é…ç½®ä¸­å¿ƒï¼Œæœ¬åœ°æµ‹è¯•å›°éš¾

**Matrix RPC çš„ä¼˜åŠ¿**ï¼š
1. **ç»Ÿä¸€æŠ½è±¡**ï¼šå°†è·¯ç”±ä½œä¸º Directory çš„å¢å¼ºï¼Œè€Œéç‹¬ç«‹ç»„ä»¶
2. **ç®€åŒ–æ¶æ„**ï¼šæ ‡ç­¾è¿‡æ»¤ + æƒé‡è´Ÿè½½å‡è¡¡åœ¨åŒä¸€å±‚æ¬¡
3. **æ¸è¿›å¼**ï¼šå…ˆæ”¯æŒé™æ€é…ç½®ï¼Œåç»­æ‰©å±•åŠ¨æ€è§„åˆ™

### 2.2 å…³é”®æƒè¡¡ç‚¹

| ç»´åº¦ | Dubbo æ–¹æ¡ˆ | Matrix RPC æ–¹æ¡ˆ | é€‰æ‹©ç†ç”± |
|------|-----------|----------------|---------|
| **è·¯ç”±ä½ç½®** | Router é“¾ï¼ˆç‹¬ç«‹ç»„ä»¶ï¼‰ | Directory å†…éƒ¨è¿‡æ»¤ | å‡å°‘æŠ½è±¡å±‚æ¬¡ï¼Œé™ä½å¤æ‚åº¦ |
| **æ ‡ç­¾ä¼ é€’** | RpcContext éšå¼ä¼ é€’ | Invocation æ˜¾å¼ä¼ é€’ | æ›´æ¸…æ™°ï¼Œæ˜“äºè¿½è¸ª |
| **æƒé‡å®ç°** | è´Ÿè½½å‡è¡¡å™¨å†…éƒ¨ | URL å‚æ•° + è´Ÿè½½å‡è¡¡ | å¤ç”¨ç°æœ‰æœºåˆ¶ï¼Œæœ€å°æ”¹åŠ¨ |
| **åŠ¨æ€è§„åˆ™** | ä¾èµ–é…ç½®ä¸­å¿ƒ | å…ˆé™æ€ï¼ŒååŠ¨æ€ | æ¸è¿›å¼æ¼”è¿›ï¼Œé™ä½ä¾èµ– |

### 2.3 ä¸ Dubbo çš„å·®å¼‚

```
Dubbo æ¶æ„ï¼š
  Consumer â†’ RouterChain â†’ Directory â†’ LoadBalance â†’ ClusterInvoker
              â†‘ (TagRouter, ConditionRouter...)
              
Matrix RPC æ¶æ„ï¼ˆç®€åŒ–ï¼‰ï¼š
  Consumer â†’ Directory(å¸¦æ ‡ç­¾è¿‡æ»¤) â†’ LoadBalance(å¸¦æƒé‡) â†’ ClusterInvoker
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘ä¸€å±‚ Router æŠ½è±¡ï¼Œé™ä½ç†è§£æˆæœ¬
- æ ‡ç­¾å’Œæƒé‡åœ¨è°ƒç”¨é“¾çš„æ­£ç¡®ä½ç½®ï¼ˆè¿‡æ»¤ â†’ é€‰æ‹© â†’ å®¹é”™ï¼‰
- æ›´å®¹æ˜“æµ‹è¯•å’Œè°ƒè¯•

## 3. æ¶æ„è®¾è®¡

### 3.1 æ¨¡å—åˆ’åˆ†

```
matrix-rpc-cluster/
â”œâ”€â”€ matrix-rpc-cluster-api/
â”‚   â”œâ”€â”€ Router.java               # æ–°å¢ï¼šè·¯ç”±æŠ½è±¡æ¥å£
â”‚   â”œâ”€â”€ TagRouter.java            # æ–°å¢ï¼šæ ‡ç­¾è·¯ç”±å®ç°
â”‚   â”œâ”€â”€ Directory.java            # å¢å¼ºï¼šæ·»åŠ è·¯ç”±è¿‡æ»¤
â”‚   â””â”€â”€ LoadBalance.java          # ç°æœ‰ï¼šå¢åŠ æƒé‡æ”¯æŒ
â”‚
â”œâ”€â”€ matrix-rpc-cluster-loadbalance/
â”‚   â”œâ”€â”€ WeightedRandomLoadBalance.java   # æ–°å¢ï¼šåŠ æƒéšæœº
â”‚   â”œâ”€â”€ WeightedRoundRobinLoadBalance.java # æ–°å¢ï¼šåŠ æƒè½®è¯¢
â”‚   â””â”€â”€ ... (ç°æœ‰è´Ÿè½½å‡è¡¡ä¿æŒä¸å˜)
â”‚
â””â”€â”€ matrix-rpc-cluster-router/     # æ–°å¢ï¼šè·¯ç”±æ¨¡å—
    â”œâ”€â”€ pom.xml
    â””â”€â”€ src/main/
        â”œâ”€â”€ java/.../router/
        â”‚   â”œâ”€â”€ TagRouterImpl.java
        â”‚   â””â”€â”€ ConditionRouter.java (åç»­æ‰©å±•)
        â””â”€â”€ resources/META-INF/matrix/
            â””â”€â”€ io.homeey.matrix.rpc.cluster.api.Router
```

### 3.2 æ ¸å¿ƒæ¥å£è®¾è®¡

#### 3.2.1 Router æ¥å£ï¼ˆè·¯ç”±æŠ½è±¡ï¼‰

```java
/**
 * è·¯ç”±æ¥å£ï¼šè´Ÿè´£æ ¹æ®è§„åˆ™è¿‡æ»¤æœåŠ¡æä¾›è€…
 * 
 * <p>ä¸ Dubbo çš„åŒºåˆ«ï¼š
 * - æ›´ç®€å•ï¼šåªå…³æ³¨è¿‡æ»¤é€»è¾‘ï¼Œä¸æ¶‰åŠè§„åˆ™ç®¡ç†
 * - èŒè´£å•ä¸€ï¼šä¸ä¾èµ–é…ç½®ä¸­å¿ƒï¼Œè§„åˆ™ç”±å¤–éƒ¨ä¼ å…¥
 */
@SPI("tag")
public interface Router {
    
    /**
     * è·¯ç”±ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
     * - æ ‡ç­¾è·¯ç”±ï¼š10
     * - æ¡ä»¶è·¯ç”±ï¼š20
     * - è‡ªå®šä¹‰è·¯ç”±ï¼š30+
     */
    int getPriority();
    
    /**
     * æ ¹æ®è·¯ç”±è§„åˆ™è¿‡æ»¤æœåŠ¡æä¾›è€…
     * 
     * @param providers åŸå§‹æä¾›è€…åˆ—è¡¨
     * @param invocation å½“å‰è°ƒç”¨ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ ‡ç­¾ç­‰ä¿¡æ¯ï¼‰
     * @return è¿‡æ»¤åçš„æä¾›è€…åˆ—è¡¨
     */
    List<URL> route(List<URL> providers, Invocation invocation);
    
    /**
     * æ˜¯å¦å¯ç”¨è¯¥è·¯ç”±è§„åˆ™
     */
    default boolean isEnabled() {
        return true;
    }
}
```

#### 3.2.2 TagRouter å®ç°ï¼ˆæ ‡ç­¾è·¯ç”±ï¼‰

```java
/**
 * æ ‡ç­¾è·¯ç”±å®ç°
 * 
 * <p>è·¯ç”±é€»è¾‘ï¼š
 * 1. ä» Invocation çš„ attachments ä¸­è·å–è¯·æ±‚æ ‡ç­¾ï¼ˆå¦‚ tag=grayï¼‰
 * 2. ä» URL å‚æ•°ä¸­è·å–å®ä¾‹æ ‡ç­¾ï¼ˆå¦‚ tag=grayï¼‰
 * 3. ä¼˜å…ˆè¿”å›æ ‡ç­¾åŒ¹é…çš„å®ä¾‹
 * 4. å¦‚æœæ²¡æœ‰åŒ¹é…å®ä¾‹ï¼Œé™çº§åˆ°æ— æ ‡ç­¾å®ä¾‹
 * 5. å¦‚æœè®¾ç½®äº† force=trueï¼Œåˆ™ä¸é™çº§ï¼Œè¿”å›ç©ºåˆ—è¡¨
 */
@Activate(order = 10)
public class TagRouter implements Router {
    
    @Override
    public int getPriority() {
        return 10;
    }
    
    @Override
    public List<URL> route(List<URL> providers, Invocation invocation) {
        // 1. è·å–è¯·æ±‚æ ‡ç­¾
        String requestTag = invocation.getAttachments().get("tag");
        if (requestTag == null || requestTag.isEmpty()) {
            // æ— æ ‡ç­¾è¯·æ±‚ï¼Œåªè¿”å›æ— æ ‡ç­¾å®ä¾‹
            return providers.stream()
                    .filter(url -> url.getParameter("tag") == null)
                    .collect(Collectors.toList());
        }
        
        // 2. è¿‡æ»¤åŒ¹é…æ ‡ç­¾çš„å®ä¾‹
        List<URL> taggedProviders = providers.stream()
                .filter(url -> requestTag.equals(url.getParameter("tag")))
                .collect(Collectors.toList());
        
        // 3. å¦‚æœæœ‰åŒ¹é…çš„å®ä¾‹ï¼Œç›´æ¥è¿”å›
        if (!taggedProviders.isEmpty()) {
            return taggedProviders;
        }
        
        // 4. é™çº§é€»è¾‘ï¼šè¿”å›æ— æ ‡ç­¾å®ä¾‹
        boolean force = "true".equals(invocation.getAttachments().get("tag.force"));
        if (force) {
            // å¼ºåˆ¶æ ‡ç­¾è·¯ç”±ï¼Œä¸é™çº§
            return Collections.emptyList();
        }
        
        // è¿”å›æ— æ ‡ç­¾å®ä¾‹ä½œä¸ºå…œåº•
        return providers.stream()
                .filter(url -> url.getParameter("tag") == null)
                .collect(Collectors.toList());
    }
}
```

#### 3.2.3 å¢å¼º Directory æ¥å£

```java
/**
 * æœåŠ¡ç›®å½•ï¼šæä¾›æœåŠ¡æä¾›è€…åˆ—è¡¨ï¼ˆå¢å¼ºç‰ˆï¼‰
 */
public interface Directory<T> {
    
    Class<T> getInterface();
    
    /**
     * è·å–åŸå§‹æä¾›è€…åˆ—è¡¨ï¼ˆæœªç»è·¯ç”±è¿‡æ»¤ï¼‰
     */
    List<URL> list();
    
    /**
     * æ ¹æ®è°ƒç”¨ä¸Šä¸‹æ–‡è·å–è·¯ç”±åçš„æä¾›è€…åˆ—è¡¨
     * 
     * @param invocation è°ƒç”¨ä¸Šä¸‹æ–‡ï¼ˆåŒ…å«æ ‡ç­¾ç­‰ä¿¡æ¯ï¼‰
     * @return ç»è¿‡è·¯ç”±è¿‡æ»¤çš„æä¾›è€…åˆ—è¡¨
     */
    default List<URL> list(Invocation invocation) {
        List<URL> providers = list();
        
        // åº”ç”¨æ‰€æœ‰è·¯ç”±è§„åˆ™ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
        List<Router> routers = ExtensionLoader.getExtensionLoader(Router.class)
                .getActivateExtensions();
        
        for (Router router : routers) {
            if (router.isEnabled()) {
                providers = router.route(providers, invocation);
                if (providers.isEmpty()) {
                    break; // æŸä¸ªè·¯ç”±å™¨è¿‡æ»¤åæ— å¯ç”¨å®ä¾‹ï¼Œæå‰é€€å‡º
                }
            }
        }
        
        return providers;
    }
}
```

#### 3.2.4 åŠ æƒè´Ÿè½½å‡è¡¡å™¨

```java
/**
 * åŠ æƒéšæœºè´Ÿè½½å‡è¡¡
 * 
 * <p>æƒé‡é…ç½®ï¼š
 * - URL å‚æ•°ï¼šweight=200 ï¼ˆé»˜è®¤ 100ï¼‰
 * - æƒé‡èŒƒå›´ï¼š1-1000
 */
@Activate
public class WeightedRandomLoadBalance implements LoadBalance {
    
    private final Random random = new Random();
    
    @Override
    public URL select(List<URL> providers, Invocation invocation) {
        if (providers.size() == 1) {
            return providers.get(0);
        }
        
        // 1. è®¡ç®—æ€»æƒé‡
        int totalWeight = 0;
        boolean sameWeight = true;
        int firstWeight = getWeight(providers.get(0));
        
        for (URL provider : providers) {
            int weight = getWeight(provider);
            totalWeight += weight;
            if (sameWeight && weight != firstWeight) {
                sameWeight = false;
            }
        }
        
        // 2. å¦‚æœæƒé‡éƒ½ç›¸åŒï¼Œç›´æ¥éšæœº
        if (sameWeight) {
            return providers.get(random.nextInt(providers.size()));
        }
        
        // 3. æŒ‰æƒé‡éšæœºé€‰æ‹©
        int offset = random.nextInt(totalWeight);
        for (URL provider : providers) {
            offset -= getWeight(provider);
            if (offset < 0) {
                return provider;
            }
        }
        
        return providers.get(0);
    }
    
    private int getWeight(URL url) {
        int weight = url.getParameter("weight", 100);
        return Math.max(1, Math.min(weight, 1000)); // é™åˆ¶èŒƒå›´ [1, 1000]
    }
}
```

### 3.3 è°ƒç”¨é“¾é›†æˆ

**ä¿®æ”¹ ClusterInvoker ä½¿ç”¨ Directory.list(invocation)**ï¼š

```java
public abstract class ClusterInvoker<T> implements Invoker<T> {
    
    protected List<URL> getProviders(Invocation invocation) {
        // ä½¿ç”¨å¢å¼ºçš„ list(invocation) æ–¹æ³•ï¼Œè‡ªåŠ¨åº”ç”¨è·¯ç”±è§„åˆ™
        return directory.list(invocation);
    }
    
    @Override
    public Result invoke(Invocation invocation) {
        // 1. è·å–ç»è¿‡è·¯ç”±è¿‡æ»¤çš„æä¾›è€…åˆ—è¡¨
        List<URL> providers = getProviders(invocation);
        
        if (providers.isEmpty()) {
            throw new RpcException("No provider available after routing");
        }
        
        // 2. è´Ÿè½½å‡è¡¡é€‰æ‹©ï¼ˆå·²æ”¯æŒæƒé‡ï¼‰
        URL selected = loadBalance.select(providers, invocation);
        
        // 3. æ‰§è¡Œè°ƒç”¨ï¼ˆå®¹é”™é€»è¾‘ï¼‰
        return doInvoke(invocation, selected);
    }
}
```

## 4. ä»£ç æ”¹åŠ¨å»ºè®®

### 4.1 åŒ…ç»“æ„è°ƒæ•´

```
æ–°å¢æ¨¡å—ï¼š
matrix-rpc-cluster-router/
  â””â”€â”€ src/main/java/io/homeey/matrix/rpc/cluster/router/
      â”œâ”€â”€ TagRouter.java
      â””â”€â”€ ConditionRouter.java (åç»­æ‰©å±•)

ä¿®æ”¹æ¨¡å—ï¼š
matrix-rpc-cluster-api/
  â”œâ”€â”€ Router.java (æ–°å¢)
  â””â”€â”€ Directory.java (å¢å¼º)

matrix-rpc-cluster-loadbalance/
  â”œâ”€â”€ WeightedRandomLoadBalance.java (æ–°å¢)
  â””â”€â”€ WeightedRoundRobinLoadBalance.java (æ–°å¢)
```

### 4.2 å…³é”®ç±»æ¸…å•

| ç±»å | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| `Router` | æ¥å£ | è·¯ç”±æŠ½è±¡ï¼ŒSPI æ‰©å±•ç‚¹ |
| `TagRouter` | å®ç° | æ ‡ç­¾è·¯ç”±å®ç° |
| `Directory` | æ¥å£ | å¢åŠ  `list(Invocation)` æ–¹æ³• |
| `RegistryDirectory` | å®ç° | å®ç°æ–°çš„ `list(Invocation)` |
| `WeightedRandomLoadBalance` | å®ç° | åŠ æƒéšæœºè´Ÿè½½å‡è¡¡ |
| `WeightedRoundRobinLoadBalance` | å®ç° | åŠ æƒè½®è¯¢è´Ÿè½½å‡è¡¡ |
| `ClusterInvoker` | åŸºç±» | ä¿®æ”¹ä¸ºè°ƒç”¨ `directory.list(invocation)` |

### 4.3 ä½¿ç”¨ç¤ºä¾‹

#### 4.3.1 Provider ç«¯è®¾ç½®æ ‡ç­¾å’Œæƒé‡

```java
// æ–¹å¼ 1ï¼šå¯åŠ¨å‚æ•°
// -Dmatrix.provider.tag=gray -Dmatrix.provider.weight=50

// æ–¹å¼ 2ï¼šä»£ç é…ç½®
RpcService.export(EchoService.class, new EchoServiceImpl(), 20880)
    .tag("gray")      // è®¾ç½®æ ‡ç­¾
    .weight(50)       // è®¾ç½®æƒé‡ï¼ˆé»˜è®¤ 100ï¼‰
    .await();
```

#### 4.3.2 Consumer ç«¯ä½¿ç”¨æ ‡ç­¾

```java
// æ–¹å¼ 1ï¼šå…¨å±€è®¾ç½®æ ‡ç­¾
RpcReference<EchoService> reference = RpcReference.create(EchoService.class)
    .address("localhost", 20880)
    .tag("gray")  // åªè°ƒç”¨ gray æ ‡ç­¾çš„å®ä¾‹
    .get();

// æ–¹å¼ 2ï¼šåŠ¨æ€è®¾ç½®æ ‡ç­¾ï¼ˆå•æ¬¡è°ƒç”¨ï¼‰
RpcContext.setAttachment("tag", "gray");
String result = echoService.echo("test");
RpcContext.removeAttachment("tag");
```

## 5. éªŒè¯ä¸æµ‹è¯•å»ºè®®

### 5.1 å•å…ƒæµ‹è¯•

```java
@Test
public void testTagRouter() {
    // 1. å‡†å¤‡æµ‹è¯•æ•°æ®
    List<URL> providers = Arrays.asList(
        new URL("matrix", "host1", 20880, "Service", Map.of("tag", "gray")),
        new URL("matrix", "host2", 20880, "Service", Map.of("tag", "stable")),
        new URL("matrix", "host3", 20880, "Service", Map.of())  // æ— æ ‡ç­¾
    );
    
    // 2. åˆ›å»ºè·¯ç”±å™¨
    TagRouter router = new TagRouter();
    
    // 3. æµ‹è¯•æ ‡ç­¾åŒ¹é…
    Invocation invocation = new SimpleInvocation(...);
    invocation.getAttachments().put("tag", "gray");
    
    List<URL> result = router.route(providers, invocation);
    assertEquals(1, result.size());
    assertEquals("host1", result.get(0).getHost());
    
    // 4. æµ‹è¯•é™çº§é€»è¾‘
    invocation.getAttachments().put("tag", "nonexist");
    result = router.route(providers, invocation);
    assertEquals(1, result.size()); // è¿”å›æ— æ ‡ç­¾å®ä¾‹
    assertEquals("host3", result.get(0).getHost());
}

@Test
public void testWeightedLoadBalance() {
    List<URL> providers = Arrays.asList(
        new URL("matrix", "host1", 20880, "Service", Map.of("weight", "100")),
        new URL("matrix", "host2", 20880, "Service", Map.of("weight", "200"))
    );
    
    WeightedRandomLoadBalance lb = new WeightedRandomLoadBalance();
    
    // ç»Ÿè®¡é€‰æ‹©åˆ†å¸ƒï¼ˆ10000 æ¬¡ï¼‰
    Map<String, Integer> counts = new HashMap<>();
    for (int i = 0; i < 10000; i++) {
        URL selected = lb.select(providers, null);
        counts.merge(selected.getHost(), 1, Integer::sum);
    }
    
    // éªŒè¯æƒé‡æ¯”ä¾‹çº¦ä¸º 1:2
    double ratio = (double) counts.get("host2") / counts.get("host1");
    assertTrue(ratio > 1.8 && ratio < 2.2); // å…è®¸ 10% è¯¯å·®
}
```

### 5.2 é›†æˆæµ‹è¯•

**åœºæ™¯ 1ï¼šç°åº¦å‘å¸ƒ**

```java
// 1. å¯åŠ¨ç¨³å®šç‰ˆ Providerï¼ˆæ— æ ‡ç­¾ï¼Œæƒé‡ 100ï¼‰
RpcService.export(EchoService.class, new EchoServiceV1(), 20880).await();

// 2. å¯åŠ¨ç°åº¦ç‰ˆ Providerï¼ˆgray æ ‡ç­¾ï¼Œæƒé‡ 10ï¼‰
RpcService.export(EchoService.class, new EchoServiceV2(), 20881)
    .tag("gray")
    .weight(10)
    .await();

// 3. æ™®é€šç”¨æˆ·è¯·æ±‚ï¼ˆæ— æ ‡ç­¾ï¼‰â†’ 100% æµé‡åˆ° V1
EchoService service1 = RpcReference.refer(EchoService.class, "localhost", 20880);
assertEquals("V1", service1.echo("test"));

// 4. ç°åº¦ç”¨æˆ·è¯·æ±‚ï¼ˆgray æ ‡ç­¾ï¼‰â†’ 100% æµé‡åˆ° V2
RpcReference<EchoService> reference = RpcReference.create(EchoService.class)
    .address("localhost", 20880)
    .tag("gray")
    .get();
assertEquals("V2", reference.echo("test"));
```

**åœºæ™¯ 2ï¼šæƒé‡è°ƒæ•´**

```java
// æ¨¡æ‹Ÿæ–°ç‰ˆæœ¬é€æ­¥æ”¾é‡ï¼šV1(100) â†’ V2(10) â†’ V2(50) â†’ V2(100)
// é€šè¿‡åŠ¨æ€è°ƒæ•´æƒé‡å®ç°æµé‡è¿ç§»
```

### 5.3 æ€§èƒ½æµ‹è¯•

```java
@BenchmarkMode(Mode.Throughput)
@Warmup(iterations = 3, time = 1)
@Measurement(iterations = 5, time = 1)
public class RouterBenchmark {
    
    @Benchmark
    public void testTagRouterPerformance() {
        // æµ‹è¯• 1000 ä¸ªå®ä¾‹ä¸‹çš„è·¯ç”±æ€§èƒ½
        // é¢„æœŸï¼š< 1msï¼Œä¸å½±å“ P99
    }
    
    @Benchmark
    public void testWeightedLoadBalancePerformance() {
        // æµ‹è¯•åŠ æƒè´Ÿè½½å‡è¡¡æ€§èƒ½
        // é¢„æœŸï¼šä¸ç®€å•éšæœºæ€§èƒ½å·®å¼‚ < 5%
    }
}
```

### 5.4 å‹æµ‹åœºæ™¯

```bash
# åœºæ™¯ 1ï¼šæ ‡ç­¾è·¯ç”±å‹æµ‹
# - 90% æ— æ ‡ç­¾æµé‡ â†’ ç¨³å®šç‰ˆ
# - 10% gray æ ‡ç­¾æµé‡ â†’ ç°åº¦ç‰ˆ
# éªŒè¯ï¼šP99 < 10msï¼ŒTPS > 10000

# åœºæ™¯ 2ï¼šæƒé‡è·¯ç”±å‹æµ‹
# - V1(weight=300) vs V2(weight=100)
# éªŒè¯ï¼šæµé‡æ¯”ä¾‹ 3:1ï¼Œè¯¯å·® < 5%
```

## 6. æ¼”è¿›è·¯çº¿

### Phase 1ï¼ˆå½“å‰ï¼‰ï¼šé™æ€è·¯ç”±
- âœ… å®ç° Router SPI
- âœ… å®ç° TagRouter
- âœ… å®ç°åŠ æƒè´Ÿè½½å‡è¡¡
- âœ… é›†æˆåˆ° Directory

### Phase 2ï¼ˆåç»­ï¼‰ï¼šåŠ¨æ€è§„åˆ™
- ğŸ”„ æ”¯æŒä»é…ç½®ä¸­å¿ƒè¯»å–è·¯ç”±è§„åˆ™
- ğŸ”„ å®ç° ConditionRouterï¼ˆæ¡ä»¶è·¯ç”±ï¼‰
- ğŸ”„ æ”¯æŒè§„åˆ™çƒ­æ›´æ–°

### Phase 3ï¼ˆé«˜çº§ï¼‰ï¼šæ™ºèƒ½è·¯ç”±
- ğŸ”„ åŸºäºå®æ—¶æµé‡çš„è‡ªé€‚åº”æƒé‡
- ğŸ”„ åŸºäºå“åº”æ—¶é—´çš„æ™ºèƒ½è·¯ç”±
- ğŸ”„ A/B æµ‹è¯•è·¯ç”±

## 7. æ€»ç»“

### 7.1 æ ¸å¿ƒä¼˜åŠ¿

1. **æ¶æ„ç®€æ´**ï¼šç›¸æ¯” Dubboï¼Œå‡å°‘ä¸€å±‚ Router æŠ½è±¡
2. **æ˜“äºç†è§£**ï¼šè·¯ç”± â†’ è´Ÿè½½å‡è¡¡ â†’ å®¹é”™ï¼Œè°ƒç”¨é“¾æ¸…æ™°
3. **æ¸è¿›å¼**ï¼šå…ˆé™æ€é…ç½®ï¼Œåç»­æ‰©å±•åŠ¨æ€è§„åˆ™
4. **é«˜æ€§èƒ½**ï¼šè·¯ç”±è®¡ç®— < 1msï¼Œæƒé‡è´Ÿè½½å‡è¡¡æ€§èƒ½æŸå¤± < 5%
5. **æ˜“æµ‹è¯•**ï¼šå•å…ƒæµ‹è¯•è¦†ç›–ç‡ > 80%

### 7.2 ä¸ Dubbo å¯¹æ¯”

| ç‰¹æ€§ | Dubbo | Matrix RPC | è¯´æ˜ |
|------|-------|------------|------|
| è·¯ç”±ä½ç½® | RouterChain | Directory å†…éƒ¨ | Matrix æ›´ç®€æ´ |
| æ ‡ç­¾ä¼ é€’ | RpcContext | Invocation | Matrix æ›´æ˜ç¡® |
| æƒé‡å®ç° | è´Ÿè½½å‡è¡¡å†…éƒ¨ | URL å‚æ•° | Matrix å¤ç”¨ç°æœ‰æœºåˆ¶ |
| åŠ¨æ€è§„åˆ™ | å¿…é¡»é…ç½®ä¸­å¿ƒ | å¯é€‰ | Matrix æ›´çµæ´» |

### 7.3 è®¾è®¡åŸåˆ™éµå¾ª

- âœ… **OCPï¼ˆå¼€é—­åŸåˆ™ï¼‰**ï¼šé€šè¿‡ Router SPI æ‰©å±•ï¼Œæ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç 
- âœ… **SRPï¼ˆå•ä¸€èŒè´£ï¼‰**ï¼šRouter åªè´Ÿè´£è¿‡æ»¤ï¼ŒLoadBalance åªè´Ÿè´£é€‰æ‹©
- âœ… **DIPï¼ˆä¾èµ–å€’ç½®ï¼‰**ï¼šä¾èµ– Router æ¥å£ï¼Œè€Œéå…·ä½“å®ç°
- âœ… **å‘åå…¼å®¹**ï¼šç°æœ‰ä»£ç æ— éœ€ä¿®æ”¹ï¼Œæ–°åŠŸèƒ½å¯é€‰å¯ç”¨

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2026-01-10  
**ä½œè€…**ï¼šMatrix RPC Team  
**çŠ¶æ€**ï¼šè®¾è®¡é˜¶æ®µ
