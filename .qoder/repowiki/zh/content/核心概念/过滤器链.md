# 过滤器链

<cite>
**本文档中引用的文件**  
- [Filter.java](file://matrix-rpc-filter/matrix-rpc-filter-api/src/main/java/io/homeey/matrix/rpc/filter/Filter.java)
- [FilterChainBuilder.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/support/FilterChainBuilder.java)
- [AccessLogFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/AccessLogFilter.java)
- [ExceptionFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/ExceptionFilter.java)
- [TimeoutFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/TimeoutFilter.java)
- [Activate.java](file://matrix-rpc-spi/src/main/java/io/homeey/matrix/rpc/spi/Activate.java)
- [FilterConfig.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/FilterConfig.java)
- [MatrixProtocol.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/MatrixProtocol.java)
- [ExtensionLoader.java](file://matrix-rpc-spi/src/main/java/io/homeey/matrix/rpc/spi/ExtensionLoader.java)
- [io.homeey.matrix.rpc.filter.Filter](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/resources/META-INF/matrix/io.homeey.matrix.rpc.filter.Filter)
</cite>

## 目录
1. [简介](#简介)
2. [过滤器接口设计](#过滤器接口设计)
3. [过滤器链构建机制](#过滤器链构建机制)
4. [内置过滤器分析](#内置过滤器分析)
5. [执行时机与作用域](#执行时机与作用域)
6. [自定义过滤器开发](#自定义过滤器开发)
7. [配置管理](#配置管理)
8. [总结](#总结)

## 简介

Matrix RPC框架通过过滤器链（Filter Chain）机制实现了横切关注点的模块化处理。该机制基于SPI（Service Provider Interface）设计，允许在不修改核心逻辑的前提下，灵活地扩展监控、鉴权、限流等功能。过滤器链采用责任链模式，在服务调用前后执行预处理和后处理逻辑，为系统提供了强大的可扩展性和可观测性支持。

## 过滤器接口设计

`Filter` 接口是Matrix RPC过滤器体系的核心契约，定义了统一的拦截方法签名。所有过滤器必须实现此接口以参与调用链的执行。

```mermaid
classDiagram
class Filter {
<<interface>>
+invoke(Invoker, Invocation) Result
}
class Invoker {
<<interface>>
+getInterface() Class
+invoke(Invocation) Result
}
class Invocation {
<<interface>>
+getServiceName() String
+methodName() String
+parameterTypes() Class[]
}
class Result {
+hasException() boolean
+getException() Throwable
}
Filter --> Invoker : "调用"
Filter --> Invocation : "接收"
Filter --> Result : "返回"
```

**过滤器来源**  
- [Filter.java](file://matrix-rpc-filter/matrix-rpc-filter-api/src/main/java/io/homeey/matrix/rpc/filter/Filter.java#L1-L24)

## 过滤器链构建机制

`FilterChainBuilder` 类负责基于SPI机制自动装配所有激活的过滤器，并按照 `@Activate` 注解的 `order` 值进行排序，最终形成责任链结构。

```mermaid
sequenceDiagram
participant MatrixProtocol as MatrixProtocol
participant FilterChainBuilder as FilterChainBuilder
participant ExtensionLoader as ExtensionLoader
participant FilterInvoker as FilterInvoker
MatrixProtocol->>FilterChainBuilder : buildInvokerChain(invoker, group)
FilterChainBuilder->>ExtensionLoader : getExtensionLoader(Filter.class)
ExtensionLoader->>ExtensionLoader : getActivateExtensions(group)
ExtensionLoader-->>FilterChainBuilder : List<Filter>
FilterChainBuilder->>FilterChainBuilder : 按order排序
loop 逆序包装
FilterChainBuilder->>FilterInvoker : new FilterInvoker(last, filter)
FilterInvoker-->>FilterChainBuilder : 包装后的Invoker
end
FilterChainBuilder-->>MatrixProtocol : 返回责任链Invoker
```

**过滤器链构建来源**  
- [FilterChainBuilder.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/support/FilterChainBuilder.java#L1-L53)
- [MatrixProtocol.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/MatrixProtocol.java#L62-L63)
- [MatrixProtocol.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/MatrixProtocol.java#L127-L128)

## 内置过滤器分析

### AccessLogFilter：访问日志记录

`AccessLogFilter` 在服务提供方记录每次RPC调用的访问日志，包括服务名、方法名、参数类型、调用耗时和结果状态。

```mermaid
flowchart TD
Start([开始]) --> CheckEnabled["检查是否启用"]
CheckEnabled --> |否| Invoke["直接调用"]
CheckEnabled --> |是| RecordStart["记录开始时间"]
RecordStart --> InvokeReal["调用真实服务"]
InvokeReal --> Success{"成功?"}
Success --> |是| CalculateCost["计算耗时"]
Success --> |否| CalculateCost
CalculateCost --> LogAccess["记录访问日志"]
LogAccess --> Return["返回结果"]
Invoke --> Return
```

**访问日志过滤器来源**  
- [AccessLogFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/AccessLogFilter.java#L1-L72)
- [FilterConfig.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/FilterConfig.java#L30-L41)

### ExceptionFilter：统一异常处理

`ExceptionFilter` 在服务提供方捕获并处理服务实现抛出的异常，将检查异常包装为 `RpcException`，并保护服务端不会因异常而崩溃。

```mermaid
flowchart TD
Start([开始]) --> CheckEnabled["检查是否启用"]
CheckEnabled --> |否| Invoke["直接调用"]
CheckEnabled --> |是| TryInvoke["尝试调用"]
TryInvoke --> InvokeReal["调用真实服务"]
InvokeReal --> HasException{"结果有异常?"}
HasException --> |是| LogException["记录异常日志"]
HasException --> |否| ReturnResult["返回结果"]
LogException --> WrapException["包装异常"]
WrapException --> ReturnWrapped["返回包装结果"]
TryInvoke --> |异常| CatchException["捕获异常"]
CatchException --> LogException
ReturnResult --> End([结束])
ReturnWrapped --> End
```

**异常处理过滤器来源**  
- [ExceptionFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/ExceptionFilter.java#L1-L82)
- [FilterConfig.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/FilterConfig.java#L30-L41)

### TimeoutFilter：调用超时控制

`TimeoutFilter` 在服务消费方检测RPC调用是否超时，主要用于记录慢调用、统计超时比例和提供可观测性。

```mermaid
flowchart TD
Start([开始]) --> CheckEnabled["检查是否启用"]
CheckEnabled --> |否| Invoke["直接调用"]
CheckEnabled --> |是| GetThreshold["获取慢调用阈值"]
GetThreshold --> RecordStart["记录开始时间"]
RecordStart --> TryInvoke["尝试调用"]
TryInvoke --> InvokeReal["调用真实服务"]
InvokeReal --> CalculateCost["计算耗时"]
CalculateCost --> IsSlow{"超过阈值?"}
IsSlow --> |是| LogSlow["记录慢调用"]
IsSlow --> |否| ReturnResult["返回结果"]
TryInvoke --> |异常| CheckTimeout["是否超时异常?"]
CheckTimeout --> |是| LogTimeout["记录超时日志"]
CheckTimeout --> |否| ReThrow["重新抛出"]
LogSlow --> ReturnResult
LogTimeout --> ReThrow
```

**超时控制过滤器来源**  
- [TimeoutFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/TimeoutFilter.java#L1-L87)
- [FilterConfig.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/FilterConfig.java#L51-L84)

## 执行时机与作用域

过滤器在服务提供方和服务消费方的执行时机存在差异：

- **服务提供方（PROVIDER）**：在 `MatrixProtocol.export()` 方法中构建过滤器链，当接收到远程调用请求时执行。
- **服务消费方（CONSUMER）**：在 `MatrixProtocol.refer()` 方法中构建过滤器链，当发起远程调用时执行。

```mermaid
erDiagram
PROVIDER ||--o{ FILTER_CHAIN : "export时构建"
CONSUMER ||--o{ FILTER_CHAIN : "refer时构建"
FILTER_CHAIN }|--o{ Filter : "包含多个"
Filter }|--o{ AccessLogFilter : "实现"
Filter }|--o{ ExceptionFilter : "实现"
Filter }|--o{ TimeoutFilter : "实现"
PROVIDER {
string group "PROVIDER"
}
CONSUMER {
string group "CONSUMER"
}
FILTER_CHAIN {
string group
int order
}
```

**执行时机来源**  
- [MatrixProtocol.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/MatrixProtocol.java#L62-L63)
- [MatrixProtocol.java](file://matrix-rpc-runtime/src/main/java/io/homeey/matrix/rpc/runtime/MatrixProtocol.java#L127-L128)
- [Activate.java](file://matrix-rpc-spi/src/main/java/io/homeey/matrix/rpc/spi/Activate.java#L17-L18)

## 自定义过滤器开发

开发自定义过滤器需要实现 `Filter` 接口，并通过 `@Activate` 注解声明其激活条件和执行顺序。

```mermaid
classDiagram
class CustomFilter {
+invoke(Invoker, Invocation) Result
}
class Filter {
<<interface>>
+invoke(Invoker, Invocation) Result
}
class Activate {
<<annotation>>
+group() String[]
+order() int
}
CustomFilter --> Filter : "实现"
CustomFilter ..> Activate : "使用"
note right of CustomFilter
必须在 META-INF/matrix/
io.homeey.matrix.rpc.filter.Filter
中配置名称映射
end note
```

**自定义过滤器来源**  
- [Filter.java](file://matrix-rpc-filter/matrix-rpc-filter-api/src/main/java/io/homeey/matrix/rpc/filter/Filter.java#L13-L14)
- [Activate.java](file://matrix-rpc-spi/src/main/java/io/homeey/matrix/rpc/spi/Activate.java#L13-L28)
- [io.homeey.matrix.rpc.filter.Filter](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/resources/META-INF/matrix/io.homeey.matrix.rpc.filter.Filter#L1-L4)

## 配置管理

`FilterConfig` 类提供了统一的配置管理机制，支持通过系统属性控制过滤器的开关和参数。

```mermaid
stateDiagram-v2
[*] --> GlobalCheck
GlobalCheck --> |matrix.filter.enabled=false| AllDisabled
GlobalCheck --> |其他| IndividualCheck
IndividualCheck --> |filter.enabled=false| FilterDisabled
IndividualCheck --> |其他| FilterEnabled
AllDisabled --> [*]
FilterDisabled --> [*]
FilterEnabled --> [*]
note right of GlobalCheck
全局开关优先级最高
end note
note right of IndividualCheck
单个过滤器可独立配置
end note
```

**配置管理来源**  
- [FilterConfig.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/FilterConfig.java#L1-L86)
- [AccessLogFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/AccessLogFilter.java#L25-L26)
- [ExceptionFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/ExceptionFilter.java#L20-L21)
- [TimeoutFilter.java](file://matrix-rpc-filter/matrix-rpc-filter-builtin/src/main/java/io/homeey/matrix/rpc/filter/builtin/TimeoutFilter.java#L21-L23)

## 总结

Matrix RPC的过滤器链设计通过SPI机制实现了高度可扩展的横切关注点处理。`Filter` 接口定义了统一的拦截契约，`FilterChainBuilder` 负责自动装配和排序，内置的 `AccessLogFilter`、`ExceptionFilter` 和 `TimeoutFilter` 分别实现了访问日志、异常处理和超时控制等关键功能。过滤器在服务提供方和消费方的不同执行时机，使得框架能够灵活地支持各种监控、鉴权、限流等场景。通过实现 `Filter` 接口并配置 `@Activate` 注解，开发者可以轻松扩展自定义功能，体现了框架良好的开放性和可维护性。