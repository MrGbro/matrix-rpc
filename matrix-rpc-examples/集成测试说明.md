# Matrix RPC 集成测试说明

## 测试准备

1. **编译项目**
```powershell
cd e:\Code\OpenSource\matrix-rpc
mvn clean compile -DskipTests
```

2. **安装治理模块到本地仓库**
```powershell
mvn install -DskipTests -pl matrix-rpc-filter/matrix-rpc-filter-sentinel,matrix-rpc-filter/matrix-rpc-filter-resilience4j
```

3. **打包示例模块**
```powershell
cd matrix-rpc-examples
mvn clean package -DskipTests
```

## 测试场景

### 场景1: Sentinel 限流测试

**步骤1: 启动 Provider**
```powershell
# 终端1
cd matrix-rpc-examples
java -cp target\classes;target\* io.homeey.matrix.rpc.example.provider.ProviderMain
```

**步骤2: 运行限流测试**
```powershell
# 终端2
cd matrix-rpc-examples
java -cp target\classes;target\* io.homeey.matrix.rpc.example.consumer.SentinelRateLimitTest
```

**预期结果**:
- 正常调用成功 (QPS < 10)
- 快速调用触发限流 (QPS > 10)
- 输出: `✅ Sentinel Rate Limiter is working!`

---

### 场景2: Sentinel 熔断测试

**步骤1: 启动 Provider** (同上)

**步骤2: 运行熔断测试**
```powershell
# 终端2
cd matrix-rpc-examples
java -cp target\classes;target\* io.homeey.matrix.rpc.example.consumer.SentinelCircuitBreakerTest
```

**预期结果**:
- 正常调用成功
- 高频异常触发熔断 (50%异常率)
- 熔断期间调用被拒绝
- 等待10秒后恢复
- 输出: `✅ Sentinel Circuit Breaker is working!`

---

### 场景3: Resilience4j 限流测试

**注意**: 需要禁用 Sentinel,避免冲突

**步骤1: 启动 Provider (禁用Sentinel)**
```powershell
# 终端1
cd matrix-rpc-examples
java -Dmatrix.filter.sentinel.ratelimiter.enabled=false -Dmatrix.filter.sentinel.circuitbreaker.enabled=false -cp target\classes;target\* io.homeey.matrix.rpc.example.provider.ProviderMain
```

**步骤2: 运行限流测试**
```powershell
# 终端2
cd matrix-rpc-examples
java -Dmatrix.filter.sentinel.ratelimiter.enabled=false -Dmatrix.filter.sentinel.circuitbreaker.enabled=false -cp target\classes;target\* io.homeey.matrix.rpc.example.consumer.Resilience4jRateLimitTest
```

**预期结果**:
- 正常调用成功 (QPS < 10)
- 快速调用触发限流 (QPS > 10)
- 输出: `✅ Resilience4j Rate Limiter is working!`

---

## 配置文件

### Sentinel 配置: `src/main/resources/sentinel-rules.properties`
```properties
# 限流规则
sentinel.flow.io.homeey.matrix.rpc.example.api.EchoService.echo.qps=10

# 熔断规则
sentinel.degrade.io.homeey.matrix.rpc.example.api.EchoService.echo.errorRatio=0.5
```

### Resilience4j 配置: `src/main/resources/resilience4j-config.properties`
```properties
# 限流器配置
resilience4j.ratelimiter.limitForPeriod=10

# 熔断器配置
resilience4j.circuitbreaker.failureRateThreshold=50
```

---

## 快速测试 (推荐)

### 使用 Maven Exec 插件

**启动 Provider**:
```powershell
cd matrix-rpc-examples
mvn compile exec:java -Dexec.mainClass=io.homeey.matrix.rpc.example.provider.ProviderMain
```

**Sentinel 限流测试**:
```powershell
# 新终端
mvn exec:java -Dexec.mainClass=io.homeey.matrix.rpc.example.consumer.SentinelRateLimitTest
```

**Sentinel 熔断测试**:
```powershell
mvn exec:java -Dexec.mainClass=io.homeey.matrix.rpc.example.consumer.SentinelCircuitBreakerTest
```

**Resilience4j 限流测试**:
```powershell
# Provider端
mvn exec:java -Dexec.mainClass=io.homeey.matrix.rpc.example.provider.ProviderMain -Dexec.args="-Dmatrix.filter.sentinel.ratelimiter.enabled=false"

# Consumer端
mvn exec:java -Dexec.mainClass=io.homeey.matrix.rpc.example.consumer.Resilience4jRateLimitTest -Dexec.args="-Dmatrix.filter.sentinel.ratelimiter.enabled=false"
```

---

## 验证要点

### ✅ Sentinel 限流验证
- [ ] 正常调用全部成功
- [ ] 快速调用部分被限流
- [ ] 日志输出: `[WARN] Rate limit exceeded for resource: ...`
- [ ] 测试结果显示: Rate Limited Count > 0

### ✅ Sentinel 熔断验证
- [ ] 正常调用成功
- [ ] 高频异常后熔断器打开
- [ ] 熔断期间调用被拒绝
- [ ] 日志输出: `[WARN] Circuit breaker triggered for resource: ...`
- [ ] 等待10秒后恢复

### ✅ Resilience4j 限流验证
- [ ] 需禁用 Sentinel
- [ ] 正常调用全部成功
- [ ] 快速调用部分被限流
- [ ] 日志输出: `[WARN] Rate limit exceeded for resource: ...`

---

## 故障排查

### 问题1: Provider无法启动

**可能原因**: 端口被占用

**解决**:
```powershell
# 查看端口占用
netstat -ano | findstr "20880"

# 杀死进程
taskkill /PID <进程ID> /F
```

### 问题2: 无限流效果

**可能原因**: 配置文件未生效

**检查**:
- 确认 `sentinel-rules.properties` 在 `target/classes` 目录下
- 查看启动日志,确认规则加载成功
- 检查资源名是否正确

### 问题3: Sentinel和Resilience4j冲突

**解决**: 测试Resilience4j时必须禁用Sentinel
```powershell
-Dmatrix.filter.sentinel.ratelimiter.enabled=false
-Dmatrix.filter.sentinel.circuitbreaker.enabled=false
```

---

## 测试完成标志

✅ **所有测试通过**:
1. Sentinel 限流测试: Rate Limited Count > 0
2. Sentinel 熔断测试: Circuit Breaker 触发
3. Resilience4j 限流测试: Rate Limited Count > 0

**输出示例**:
```
========================================
Test Results:
  Success Count: 10
  Rate Limited Count: 10
  Total: 20
========================================

✅ Sentinel Rate Limiter is working!
```

---

**测试文档**: Matrix RPC Team  
**更新日期**: 2026-01-11
