# Matrix RPC 客户端能力集成测试指南

> **版本**: 0.0.6  
> **创建日期**: 2026-01-14  
> **测试范围**: 连接池、断线重连、异步调用、泛化调用

---

## 📋 目录

- [测试概览](#测试概览)
- [环境准备](#环境准备)
- [测试列表](#测试列表)
  - [1. 连接池功能测试](#1-连接池功能测试)
  - [2. 异步调用功能测试](#2-异步调用功能测试)
  - [3. 泛化调用功能测试](#3-泛化调用功能测试)
  - [4. 断线重连功能测试](#4-断线重连功能测试)
- [测试结果分析](#测试结果分析)
- [常见问题](#常见问题)

---

## 测试概览

本测试套件验证 Matrix RPC 框架的四大核心客户端能力：

| 能力 | 描述 | 测试类 |
|------|------|--------|
| **连接池** | 支持多连接池化，提升并发性能 | `ConnectionPoolTest.java` |
| **断线重连** | 指数退避重连机制，保障服务稳定性 | `ReconnectTest.java` |
| **异步调用** | CompletableFuture 异步调用，提高吞吐量 | `AsyncCallTest.java` |
| **泛化调用** | 无需接口定义的动态调用 | `GenericCallTest.java` |

---

## 环境准备

### 1. 启动 Provider

```bash
cd matrix-rpc-examples/matrix-rpc-example-provider
mvn compile exec:java -Dexec.mainClass="io.homeey.example.provider.ProviderMain"
```

**预期输出**:
```
Provider started on 0.0.0.0:20880
```

### 2. 确认 Provider 端口

```bash
# Windows PowerShell
netstat -ano | findstr :20880

# 如果端口被占用
taskkill /F /PID <进程PID>
```

---

## 测试列表

### 1. 连接池功能测试

#### 测试类
`io.homeey.example.consumer.ConnectionPoolTest`

#### 测试场景
- ✅ 单连接模式（默认）
- ✅ 并发调用测试（10线程）

#### 运行测试

```bash
cd matrix-rpc-examples/matrix-rpc-example-consumer
mvn compile exec:java -Dexec.mainClass="io.homeey.example.consumer.ConnectionPoolTest"
```

#### 预期输出

```
=== 连接池功能测试 ===

【测试1】单连接模式
  调用1: Echo: Hello-1
  调用2: Echo: Hello-2
  调用3: Echo: Hello-3
  调用4: Echo: Hello-4
  调用5: Echo: Hello-5
  ✅ 单连接模式测试通过

【测试2】并发调用测试
  线程0: Echo: Thread-0
  线程1: Echo: Thread-1
  ...
  线程9: Echo: Thread-9
  ✅ 并发调用测试通过

=== 测试完成 ===
```

#### 验证要点
- [x] 所有调用均成功返回
- [x] 并发调用无线程安全问题
- [x] 无连接泄漏（观察日志）

---

### 2. 异步调用功能测试

#### 测试类
`io.homeey.example.consumer.AsyncCallTest`

#### 测试场景
- ✅ 同步调用（基准对比）
- ✅ 单次异步调用
- ✅ 全局异步模式
- ✅ 异步调用链式处理

#### 运行测试

```bash
mvn compile exec:java -Dexec.mainClass="io.homeey.example.consumer.AsyncCallTest"
```

#### 预期输出

```
=== 异步调用功能测试 ===

【测试1】同步调用
  结果: Echo: Sync Call
  耗时: 15ms
  ✅ 同步调用测试通过

【测试2】单次异步调用
  调用已发起，立即返回（非阻塞）
  结果: Echo: Async Call
  耗时: 16ms
  ✅ 单次异步调用测试通过

【测试3】全局异步模式
  结果1: Echo: Async-1
  结果2: Echo: Async-2
  结果3: Echo: Async-3
  ✅ 全局异步模式测试通过

【测试4】异步调用链式处理
  第1步处理: Echo: Chain Call
  第2步处理: ECHO: CHAIN CALL
  最终结果: ECHO: CHAIN CALL [已处理]
  ✅ 异步调用链式处理测试通过

=== 测试完成 ===
```

#### 验证要点
- [x] 异步调用立即返回（非阻塞）
- [x] CompletableFuture 正确返回结果
- [x] 链式处理按顺序执行
- [x] AsyncContext 清理无泄漏

---

### 3. 泛化调用功能测试

#### 测试类
`io.homeey.example.consumer.GenericCallTest`

#### 测试场景
- ✅ 无接口定义的泛化调用
- ✅ 不同参数类型测试
- ✅ 错误处理（调用不存在的方法）

#### 运行测试

```bash
mvn compile exec:java -Dexec.mainClass="io.homeey.example.consumer.GenericCallTest"
```

#### 预期输出

```
=== 泛化调用功能测试 ===

【测试1】基本泛化调用
  调用方法: echo(String)
  返回结果: Echo: Generic Call
  ✅ 基本泛化调用测试通过

【测试2】复杂参数泛化调用
  中文参数: Echo: 测试中文
  ✅ 复杂参数泛化调用测试通过

【测试3】错误处理
  ✅ 正确捕获异常: RpcException
  异常信息: Method not found: nonExistentMethod
  ✅ 错误处理测试通过

=== 测试完成 ===
```

#### 验证要点
- [x] 无需接口定义即可调用
- [x] 支持中文和特殊字符
- [x] 错误方法抛出正确异常

---

### 4. 断线重连功能测试

#### 测试类
`io.homeey.example.consumer.ReconnectTest`

#### 测试场景
- ✅ 正常连接调用
- ✅ 服务端断开后自动重连
- ✅ 指数退避延迟验证（1s → 2s → 4s → 8s → 16s → 30s）

#### 运行测试

```bash
mvn compile exec:java -Dexec.mainClass="io.homeey.example.consumer.ReconnectTest"
```

#### 测试步骤

**重要**：这是一个**手动交互测试**，需要人工干预！

1. ✅ 确保 Provider 已启动
2. ✅ 启动测试程序（会持续调用60次，每次间隔2秒）
3. ✅ **在测试运行期间，手动停止 Provider**（Ctrl+C）
4. ✅ 观察客户端重连日志
5. ✅ **重新启动 Provider**
6. ✅ 观察自动重连成功

#### 预期输出

**正常调用阶段**:
```
【测试】断线重连
  [1] ✅ 调用成功: Echo: Call-1
  [2] ✅ 调用成功: Echo: Call-2
  [3] ✅ 调用成功: Echo: Call-3
```

**Provider 停止后**:
```
  [15] ❌ 调用失败: Connection refused
  [16] ❌ 调用失败: Connection refused
  
  -- 重连日志（后台线程） --
  INFO: Reconnecting to localhost:9090 in 1000ms (attempt 1)
  INFO: Reconnecting to localhost:9090 in 2000ms (attempt 2)
  INFO: Reconnecting to localhost:9090 in 4000ms (attempt 3)
  INFO: Reconnecting to localhost:9090 in 8000ms (attempt 4)
```

**Provider 重启后**:
```
  INFO: Successfully reconnected to localhost:9090 after 5 attempts
  INFO: Reconnect successful, added new channel to pool
  
  [28] ✅ 调用成功: Echo: Call-28
  [29] ✅ 调用成功: Echo: Call-29
  --- 统计：成功=48, 失败=12 ---
```

#### 验证要点
- [x] 重连延迟符合指数退避序列
- [x] 重连成功后立即恢复调用
- [x] 无内存泄漏（后台线程正确管理）
- [x] 日志清晰显示重连过程

---

## 测试结果分析

### 成功标准

| 测试项 | 成功标准 |
|--------|---------|
| **连接池** | 并发10线程全部成功，无异常 |
| **异步调用** | 4个测试场景全部通过，Future正确返回 |
| **泛化调用** | 无接口定义成功调用，错误处理正确 |
| **断线重连** | 断线后自动重连，延迟符合预期 |

### 性能指标参考

```
单次同步调用：     ~15ms
单次异步调用：     ~16ms（含Future开销）
并发10线程调用：   ~200ms 总耗时
重连首次延迟：     1000ms
重连最大延迟：     30000ms
```

---

## 常见问题

### 1. Provider 端口被占用

**现象**：
```
Address already in use: bind
```

**解决**：
```bash
# 查找占用端口的进程
netstat -ano | findstr :9090

# 强制终止进程
taskkill /F /PID <进程PID>
```

### 2. 异步调用卡住

**现象**：
```
Future.get() 超时
```

**原因**：
- AsyncContext 未正确清理
- Provider 未启动

**解决**：
- 确保 `AsyncContext.disableAsync()` 在 finally 块中
- 检查 Provider 状态

### 3. 泛化调用报错

**现象**：
```
ClassCastException: cannot be cast to GenericService
```

**原因**：
- 未设置 `.generic(serviceName)`
- serviceName 错误

**解决**：
```java
RpcReference.create(GenericService.class)
    .generic("io.homeey.example.api.EchoService")  // 必须设置
    .get();
```

### 4. 重连测试看不到日志

**原因**：
- 日志级别过高
- 后台线程延迟执行

**解决**：
- 调整 logback.xml 日志级别为 INFO
- 耐心等待重连延迟（最长30秒）

---

## 附录：测试文件清单

```
matrix-rpc-examples/
└── matrix-rpc-example-consumer/
    └── src/main/java/io/homeey/example/consumer/
        ├── ConnectionPoolTest.java    (95行)  - 连接池测试
        ├── AsyncCallTest.java        (166行)  - 异步调用测试
        ├── GenericCallTest.java      (117行)  - 泛化调用测试
        └── ReconnectTest.java         (87行)  - 断线重连测试
```

**总计**: 4个测试类，465行测试代码

---

## 许可证

Matrix RPC Framework © 2026

---

**Happy Testing! 🎉**
