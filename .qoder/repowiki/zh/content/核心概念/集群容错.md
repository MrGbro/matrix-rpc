# 集群容错

<cite>
**本文档引用文件**  
- [Cluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Cluster.java)
- [LoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/LoadBalance.java)
- [Directory.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Directory.java)
- [Router.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Router.java)
- [RouteRule.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/RouteRule.java)
- [ConfigCenter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/ConfigCenter.java)
- [ClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/ClusterInvoker.java)
- [FailoverCluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailoverCluster.java)
- [FailoverClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailoverClusterInvoker.java)
- [FailfastCluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailfastCluster.java)
- [FailfastClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailfastClusterInvoker.java)
- [FailsafeCluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailsafeCluster.java)
- [FailsafeClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailsafeClusterInvoker.java)
- [RandomLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/RandomLoadBalance.java)
- [RoundRobinLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/RoundRobinLoadBalance.java)
- [WeightedRandomLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/WeightedRandomLoadBalance.java)
- [WeightedRoundRobinLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/WeightedRoundRobinLoadBalance.java)
- [ConsistentHashLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/ConsistentHashLoadBalance.java)
- [ConditionRouter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/ConditionRouter.java)
- [TagRouter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/TagRouter.java)
- [MemoryConfigCenter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/MemoryConfigCenter.java)
- [DynamicRouter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/DynamicRouter.java)
</cite>

## 目录
1. [简介](#简介)
2. [集群容错架构](#集群容错架构)
3. [核心组件分析](#核心组件分析)
4. [容错策略实现](#容错策略实现)
5. [负载均衡机制](#负载均衡机制)
6. [路由与过滤机制](#路由与过滤机制)
7. [配置中心集成](#配置中心集成)
8. [调用流程分析](#调用流程分析)
9. [扩展机制](#扩展机制)
10. [最佳实践](#最佳实践)

## 简介

Matrix RPC 框架的集群容错模块提供了完整的服务调用容错能力，包括失败重试、快速失败、失败安全等多种策略，结合负载均衡和路由机制，确保分布式环境下服务调用的高可用性和稳定性。

**本节不涉及具体源码文件分析，因此无来源标注**

## 集群容错架构

Matrix RPC 的集群容错架构采用分层设计，各组件协同工作：

```mermaid
graph TB
subgraph "消费者"
Proxy[代理层]
ClusterInvoker[ClusterInvoker]
end
subgraph "集群层"
Directory[Directory]
LoadBalance[LoadBalance]
Router[Router]
end
subgraph "服务提供者"
Provider[服务实例1]
Provider2[服务实例2]
Provider3[服务实例3]
end
Proxy --> ClusterInvoker
ClusterInvoker --> Directory
Directory --> Router
Directory --> LoadBalance
LoadBalance --> Provider
LoadBalance --> Provider2
LoadBalance --> Provider3
Router --> Provider
Router --> Provider2
Router --> Provider3
style ClusterInvoker fill:#f9f,stroke:#333
style LoadBalance fill:#bbf,stroke:#333
style Router fill:#f96,stroke:#333
```

**图示来源**  
- [Cluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Cluster.java)
- [Directory.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Directory.java)
- [LoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/LoadBalance.java)
- [Router.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Router.java)

## 核心组件分析

### Cluster 接口

`Cluster` 接口是容错策略的核心SPI，负责将服务目录和负载均衡器组合成具有容错能力的 `ClusterInvoker`。框架默认支持多种容错策略。

**组件来源**  
- [Cluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Cluster.java)

### Directory 服务目录

`Directory` 作为服务提供者列表的管理器，是集群层与服务实例之间的桥梁。它支持通过路由规则动态过滤可用的服务实例。

```mermaid
classDiagram
class Directory~T~ {
+Class~T~ getInterface()
+URL[] list()
+URL[] list(Invocation)
}
class RegistryDirectory~T~ {
-Class~T~ interfaceClass
-Supplier~URL[]~ providerSupplier
+RegistryDirectory(Class~T~, Supplier~URL[]~)
+Class~T~ getInterface()
+URL[] list()
}
Directory~T~ <|-- RegistryDirectory~T~
```

**图示来源**  
- [Directory.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Directory.java)
- [RegistryDirectory.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/RegistryDirectory.java)

## 容错策略实现

### Failover 失败重试

Failover 策略在调用失败后自动切换到其他节点重试，适用于幂等性查询操作。支持配置重试次数。

```mermaid
sequenceDiagram
participant Consumer
participant ClusterInvoker
participant ProviderA
participant ProviderB
Consumer->>ClusterInvoker : invoke(request)
ClusterInvoker->>ProviderA : 调用
ProviderA-->>ClusterInvoker : 失败
ClusterInvoker->>ProviderB : 重试调用
ProviderB-->>ClusterInvoker : 成功
ClusterInvoker-->>Consumer : 返回结果
```

**组件来源**  
- [FailoverCluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailoverCluster.java)
- [FailoverClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailoverClusterInvoker.java)

### Failfast 快速失败

Failfast 策略在调用失败后立即抛出异常，不进行重试，适用于非幂等写操作或对实时性要求高的场景。

```mermaid
sequenceDiagram
participant Consumer
participant ClusterInvoker
participant Provider
Consumer->>ClusterInvoker : invoke(request)
ClusterInvoker->>Provider : 调用
Provider-->>ClusterInvoker : 失败
ClusterInvoker-->>Consumer : 立即抛出异常
```

**组件来源**  
- [FailfastCluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailfastCluster.java)
- [FailfastClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailfastClusterInvoker.java)

### Failsafe 失败安全

Failsafe 策略在调用失败后忽略异常，返回空结果，适用于对结果不敏感的场景，如日志上报、监控数据收集等。

```mermaid
sequenceDiagram
participant Consumer
participant ClusterInvoker
participant Provider
Consumer->>ClusterInvoker : invoke(request)
ClusterInvoker->>Provider : 调用
Provider-->>ClusterInvoker : 失败
ClusterInvoker-->>Consumer : 返回空结果
```

**组件来源**  
- [FailsafeCluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailsafeCluster.java)
- [FailsafeClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/FailsafeClusterInvoker.java)

## 负载均衡机制

### 基础负载均衡策略

Matrix RPC 提供了多种负载均衡策略，通过 `LoadBalance` SPI 接口实现。

```mermaid
classDiagram
class LoadBalance {
+URL select(URL[] providers, Invocation invocation)
}
class RandomLoadBalance {
+URL select(URL[] providers, Invocation invocation)
}
class RoundRobinLoadBalance {
+URL select(URL[] providers, Invocation invocation)
}
class ConsistentHashLoadBalance {
+URL select(URL[] providers, Invocation invocation)
}
LoadBalance <|-- RandomLoadBalance
LoadBalance <|-- RoundRobinLoadBalance
LoadBalance <|-- ConsistentHashLoadBalance
```

**图示来源**  
- [LoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/LoadBalance.java)
- [RandomLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/RandomLoadBalance.java)
- [RoundRobinLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/RoundRobinLoadBalance.java)
- [ConsistentHashLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/ConsistentHashLoadBalance.java)

### 加权负载均衡

支持基于权重的负载均衡策略，可根据服务实例的性能分配不同权重。

```mermaid
classDiagram
class WeightedRandomLoadBalance {
+URL select(URL[] providers, Invocation invocation)
}
class WeightedRoundRobinLoadBalance {
+URL select(URL[] providers, Invocation invocation)
}
LoadBalance <|-- WeightedRandomLoadBalance
LoadBalance <|-- WeightedRoundRobinLoadBalance
```

**组件来源**  
- [WeightedRandomLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/WeightedRandomLoadBalance.java)
- [WeightedRoundRobinLoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-loadbalance/src/main/java/io/homeey/matrix/rpc/cluster/loadbalance/WeightedRoundRobinLoadBalance.java)

## 路由与过滤机制

### 路由接口设计

`Router` 接口负责根据规则过滤服务提供者，支持标签路由、条件路由等场景。

```mermaid
classDiagram
class Router {
+int getPriority()
+URL[] route(URL[] providers, Invocation invocation)
+boolean isEnabled()
}
class TagRouter {
+int getPriority()
+URL[] route(URL[] providers, Invocation invocation)
}
class ConditionRouter {
+int getPriority()
+URL[] route(URL[] providers, Invocation invocation)
}
Router <|-- TagRouter
Router <|-- ConditionRouter
```

**图示来源**  
- [Router.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Router.java)
- [TagRouter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/TagRouter.java)
- [ConditionRouter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/ConditionRouter.java)

### 路由规则结构

`RouteRule` 类定义了路由规则的数据结构，支持多种路由条件和动作。

```mermaid
classDiagram
class RouteRule {
-String name
-int priority
-boolean enabled
-Condition[] conditions
-Action action
+String getName()
+void setName(String)
+int getPriority()
+void setPriority(int)
+boolean isEnabled()
+void setEnabled(boolean)
+Condition[] getConditions()
+void setConditions(Condition[])
+Action getAction()
+void setAction(Action)
}
class Condition {
-String key
-Operator operator
-String value
}
class Action {
-ActionType type
-String target
-boolean force
}
class Operator {
+EQUAL
+NOT_EQUAL
+CONTAINS
+REGEX
+GREATER_THAN
+LESS_THAN
}
class ActionType {
+FILTER
+EXCLUDE
+WEIGHT
}
RouteRule *-- Condition
RouteRule *-- Action
```

**组件来源**  
- [RouteRule.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/RouteRule.java)

## 配置中心集成

### 配置中心接口

`ConfigCenter` 接口用于动态获取和监听路由规则配置，支持多种配置中心实现。

```mermaid
classDiagram
class ConfigCenter {
+void init(String address)
+RouteRule[] getRouteRules(String serviceName)
+void addListener(String serviceName, Consumer~RouteRule[]~ listener)
+void removeListener(String serviceName)
+void publishRouteRules(String serviceName, RouteRule[] rules)
+void close()
}
class MemoryConfigCenter {
+void init(String address)
+RouteRule[] getRouteRules(String serviceName)
+void addListener(String serviceName, Consumer~RouteRule[]~ listener)
+void removeListener(String serviceName)
+void publishRouteRules(String serviceName, RouteRule[] rules)
+void close()
}
ConfigCenter <|-- MemoryConfigCenter
```

**组件来源**  
- [ConfigCenter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/ConfigCenter.java)
- [MemoryConfigCenter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-router/src/main/java/io/homeey/matrix/rpc/cluster/router/MemoryConfigCenter.java)

## 调用流程分析

### 完整调用链路

展示了从消费者到服务提供者的完整调用流程，包含路由、负载均衡和容错处理。

```mermaid
flowchart TD
Start([消费者调用]) --> Proxy["代理层拦截"]
Proxy --> ClusterInvoker["ClusterInvoker"]
ClusterInvoker --> Directory["Directory.list(invocation)"]
Directory --> RouterChain["Router链式过滤"]
RouterChain --> |应用路由规则| FilteredProviders["获取过滤后的提供者列表"]
FilteredProviders --> LoadBalance["LoadBalance.select()"]
LoadBalance --> |选择节点| SelectedProvider["选中的服务提供者"]
SelectedProvider --> Transport["TransportClient.send()"]
Transport --> Provider["服务提供者"]
Provider --> |返回结果| End([返回结果])
style ClusterInvoker fill:#f9f,stroke:#333
style LoadBalance fill:#bbf,stroke:#333
style RouterChain fill:#f96,stroke:#333
```

**组件来源**  
- [ClusterInvoker.java](file://matrix-rpc-cluster/matrix-rpc-cluster-failover/src/main/java/io/homeey/matrix/rpc/cluster/failover/ClusterInvoker.java)
- [Directory.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Directory.java)
- [Router.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Router.java)
- [LoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/LoadBalance.java)

## 扩展机制

### SPI 扩展点

Matrix RPC 通过 SPI 机制提供灵活的扩展能力，各核心组件均可通过配置进行替换。

```mermaid
erDiagram
CLUSTER ||--o{ IMPLEMENTATION : "实现"
LOAD_BALANCE ||--o{ IMPLEMENTATION : "实现"
ROUTER ||--o{ IMPLEMENTATION : "实现"
CONFIG_CENTER ||--o{ IMPLEMENTATION : "实现"
CLUSTER {
string name PK
string description
}
LOAD_BALANCE {
string name PK
string description
}
ROUTER {
string name PK
string description
}
CONFIG_CENTER {
string name PK
string description
}
IMPLEMENTATION {
string class_name PK
string module
string description
}
```

**组件来源**  
- [Cluster.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Cluster.java)
- [LoadBalance.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/LoadBalance.java)
- [Router.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/Router.java)
- [ConfigCenter.java](file://matrix-rpc-cluster/matrix-rpc-cluster-api/src/main/java/io/homeey/matrix/rpc/cluster/api/ConfigCenter.java)

## 最佳实践

### 容错策略选择

根据业务场景选择合适的容错策略：

| 场景 | 推荐策略 | 说明 |
|------|----------|------|
| 查询操作 | Failover | 允许重试，提高成功率 |
| 写操作 | Failfast | 避免重复提交，保证数据一致性 |
| 日志上报 | Failsafe | 失败不影响主流程 |

### 负载均衡配置

根据服务特点选择合适的负载均衡策略：

| 服务类型 | 推荐策略 | 说明 |
|---------|----------|------|
| 无状态服务 | RoundRobin | 请求均匀分布 |
| 性能差异大 | WeightedRandom | 按权重分配流量 |
| 缓存敏感 | ConsistentHash | 减少缓存失效 |

**本节为通用建议，不涉及具体源码文件分析，因此无来源标注**